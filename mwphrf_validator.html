<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>MWPHRF Validator</title>
<!-- jQuery -->
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5 -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous" />
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
	crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/be95d6b295.js" crossorigin="anonymous"></script>

<!-- DataTables -->
<!-- Included libraries:
 * To rebuild or modify this file with the latest versions of the included
 * software please visit:
 *   https://datatables.net/download/#bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1
 *
 * Included libraries:
 *  JSZip 3.10.1, DataTables 2.3.2, Buttons 3.2.4, Column visibility 3.2.4, HTML5 export 3.2.4, Print view 3.2.4, ColReorder 2.1.1, DateTime 1.5.6, FixedColumns 5.0.4, FixedHeader 4.0.3, KeyTable 2.12.1, Responsive 3.0.5, RowGroup 1.5.2, Scroller 2.4.3, SearchBuilder 1.8.3, SearchPanes 2.3.4, Select 3.0.1
-->
<link href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1/datatables.min.css" rel="stylesheet" integrity="sha384-AJLr9lKaaCuSjzByAYUCZ33XS5Nl5K+kqmz154VoRrooT7qAG8f71ZhRpdXC+Cw/" crossorigin="anonymous">
 
<script src="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1/datatables.min.js" integrity="sha384-01l+g4SkAg57RpPg0lgbZedebEdRAl+YD5+n67Mv/77+6vwyYSMEcrd1glx6eMPa" crossorigin="anonymous"></script>


<script src="js/moment.min.js"></script>
<script src="js/mwphrf.js"></script>

<script src="https://unpkg.com/papaparse@5.5.3/papaparse.min.js"></script>

<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" 
	integrity="sha512-hUhvpC5f8cgc04OZb55j0KNGh4eh7dLxd/dPSJ5VyzqDWxsayYbojWyl5Tkcgrmb/RVKCRJI1jNlRbVP4WWC4w==" 
	crossorigin="anonymous" 
	referrerpolicy="no-referrer"></script>
-->

<script type="text/javascript" src="js/rms.js"></script>
</head>

<body class="d-flex flex-column h-100">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-check-to-slot fa-lg"></i> MWPHRF Validator</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
	  <li class="nav-item dropdown">
	    <a class="nav-link dropdown-toggle" href="#" id="navbarLoad" role="button" data-bs-toggle="dropdown" aria-expanded="false">Load</a>
            <ul class="dropdown-menu" aria-labelledby="navbarLoad">
	      <li><a class="dropdown-item" href="#" onclick="$('#ysevents').modal('show')">YachtScoring</a></li>
	      <li><a class="dropdown-item" href="#" onclick="$('#csevents').modal('show')">The ClubSpot</a></li>
	      <li><a class="dropdown-item" href="#" onclick="displayRMDialog()">RailMeets</a></li>
            </ul>
	  </li>
	  <li class="nav-item dropdown">
	    <a class="nav-link dropdown-toggle" href="#" id="navbarMWPHRF" role="button" data-bs-toggle="dropdown" aria-expanded="false">MWPHRF</a>
            <ul class="dropdown-menu" aria-labelledby="navbarMWPHRF">
	      <!-- <li><a class="dropdown-item" href="#" onclick="$('#mwphrf-load').modal('show')">Load Ratings from MWPRHF</a></li> -->
	      <li><a class="dropdown-item" href="#" onclick="$('#mwphrf-match').modal('show')">Find matches</a></li>
	      <li><a class="dropdown-item" href="#" onclick="$('#mwphrf-setvar').modal('show')">Set variable</a></li>
          </ul>
	  <li class="nav-item">
	    <a class="nav-link" href="#" onclick="$('#clearData').modal('show')">Clear</a>
	  </li>
	  <li class="nav-item">
	    <a class="nav-link" href="#" onclick="$('#help').modal('show')">Help</a>
	  </li>
	</ul>
	<span class="d-flex">
	  <a class="btn btn-outline-light" href="index.html">All tools</a>
	</span>
      </div>
    </div>
  </nav>

    <!-- Modal to clear data-->
    <div class="modal fade" id="clearData" tabindex="-1" role="dialog" aria-labelledby="Clear data">
      <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
          <div class="modal-body">
		  <h4>Clear existing table data?</h4>
          </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-danger' onclick="clearTables()">Confirm</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to select an event from YachtScoring -->
    <div class="modal fade" id="ysevents" tabindex="-1" role="dialog" aria-labelledby="Select YachtScoring Event(s)">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select YachtScoring Event(s)</h3></div>
          <div class="modal-body">
	    <div class="input-group">
	      <input type="text" id="ys-search" class="form-control" placeholder="Query"/>
	      <button class="btn btn-primary" onclick="runYSSearch()">Search</button>
	    </div>
	    <div class="row mt-2">
              <table id="ysevent-table" class="table table-striped rms-table" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectYSEvent()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to select an event from Clubspot -->
    <div class="modal fade" id="csevents" tabindex="-1" role="dialog" aria-labelledby="Select The ClubSpot Event(s)">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select The ClubSpot Event(s)</h3></div>
          <div class="modal-body">
	    <div class="input-group">
	      <input type="text" id="cs-search" class="form-control" placeholder="Query"/>
	      <button class="btn btn-primary" onclick="runCSSearch()">Search</button>
	    </div>
	    <div class="row mt-2">
              <table id="csevent-table" class="table table-striped rms-table" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectCSEvent()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to select an event from Railmeets -->
    <div class="modal fade" id="rmevents" tabindex="-1" role="dialog" aria-labelledby="Select RailMeets Event(s)">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select RailMeets Event(s)</h3></div>
          <div class="modal-body">
	    <div class="row mt-2">
              <table id="rmevent-table" class="table table-striped rms-table" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectRMEvent()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to get data from MWPHRF -->
    <div class="modal fade" id="mwphrf-load" tabindex="-1" role="dialog" aria-labelledby="Select MWPHRF Region(s)">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select MWPHRF Region(s)</h3></div>
          <div class="modal-body">
	    <label for="mwphrf-region" class="form-label">Region(s)</label>
	    <select class="form-select" id="mwphrf-region" multiple size="9">
	      <option value="1">1 - Lake Huron</option>
	      <option value="2">2 - Mackinac Straits through and including Port Washington</option>
	      <option value="3">3 - From Port Washington through and including Racine WI</label>
	      <option value="4">4 - From Racine to, but not including, Wilmette IL</label>
	      <option value="5">5 - Wilmette to but not including Michigan City</label>
	      <option value="6">6 - Michigan City to Little Sable Point</option>
	      <option value="6">7 - Little Sable Point to the Straits of Mackinac</option>
	      <option value="6">8 - Lake Superior including Sault Ste Marie MI and Canada. Areas not covered above.</option>
	      <option value="6">9 - Western Lake Erie incl. Lake St. Clair and connecting waterways</option>
            </select>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="getMWPHRFData()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to set matches -->
    <div class="modal fade" id="mwphrf-match" tabindex="-1" role="dialog" aria-labelledby="Find MWPHRF Match(es)">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Find MWPHRF Match(es)</h3></div>
          <div class="modal-body">
	    <label class="form-label">Search by:</label>
	    <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="mwphrf-match" value="sail" id="match-sailnumber" checked>
              <label class="form-check-label" for="match-sailnumber">Sail number</label>
	    </div>
	    <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="mwphrf-match" value="name" id="match-boatname" checked>
              <label class="form-check-label" for="match-boatname">Boat name</label>
	    </div>
	    <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="mwphrf-match" value="type" id="match-makemodel">
              <label class="form-check-label" for="match-makemodel">Make/Model</label>
	    </div>
	    <div class="input-group">
              <span class="input-group-text">Match method</span>
              <select class="form-select" id="mwphrf-match-method">
                <option selected value="skip">Skip previously matched entries</option>
                <option value="add">Add to entires previously matched</option>
                <option value="overwrite">Overwrite previous matches</option>
              </select>
            </div>

	    <p>
              <input class="form-check-input" type="checkbox" name="mwphrf-year" value="current" id="match-year" checked>
              <label class="form-check-label" for="match-year">Only match certificates for current year</label>
	    </p>

            <p><i>NOTE!</i>: Will only look for matches for filtered data in the entry table</p>
	    <div class="progress">
  		<div class="progress-bar" id="mwphrf_progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
	    </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button id="mwphrf_find_btn" type='button' class='btn btn-primary' onclick="findMWPHRFMatch()">Find</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to set MWPHRF variable -->
    <div class="modal fade" id="mwphrf-setvar" tabindex="-1" role="dialog" aria-labelledby="Set MWPHRF Variable">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Set MWPHRF Variable</h3></div>
          <div class="modal-body">
	    <label for="mwphrf-var" class="form-label">Ratings variable</label>
	    <select class="form-select" id="mwphrf-var">
	      <option>HCP</option>
	      <option>DHCP</option>
	      <option>NSHCP</option>
            </select>
            <p><i>NOTE!</i>: Will only set the MWPHRF variable for filtered data in the entry table</p>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="setMWPHRFVar()">Set</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to set MWPHRF cert for a entry -->
    <div class="modal fade" id="select-cert" tabindex="-1" role="dialog" aria-labelledby="Select certificate">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select MWPHRF certificate</h3></div>
          <div class="modal-body">
	    <div class="row mt-2">
	      <div class="card">
	        <div class="card-body">
                  <h5 class="card-title">Entry</h5>
		  <p class="card-text" id="select-cert-entry"></p>
		</div>
	      </div>
              <table id="cert-table" class="table table-striped" style="width:100%">
                <thead>
	          <tr>
		   <th>Sail #</th>
		   <th>Yacht name</th>
		   <th>Make-model</th>
		   <th>Issued on</th>
		   <th>BHCP</th>
		   <th>HCP</th>
		   <th>DHCP</th>
		   <th>NSHCP</th>
		   <th>Link</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button id="mwphrf_set_btn" type='button' class='btn btn-primary' onclick="setMatch()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to display help -->
    <div class="modal fade" id="help" tabindex="-1" role="dialog" aria-labelledby="Help">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
		  <h5 class="modal-title">MWPHRF Validator v1.1</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	  </div>
          <div class="modal-body">
		<p>This tools is used to validate MWPHRF ratings for entries from YachtScoring, The ClubSpot and RailMeets.</p>
			  <ul>
			    <li>Use the <b>Load</b> menu to select the event from the different regatta websites.</li>
                            <li>If needed, you can use the <b>Filters</b> to set filters for the displayed entry data.  You can select multiple options in a single filter with Ctrl-click.</li>
			    <li>Use the <b>MPWHRF</b> menu to..
				<ol><li><b>Find matches</b> of the filtered entries to current MWPHRF certificate data</li>
				<li><b>Set variable</b>, i.e. HCP, DHCP or NSHCP, to compare from the matched cetificates with requested ratings.</li></ol>
			    </li>
			    <li>Use the <b>Copy</b>, <b>Excel</b>, <b>TSV</b> or <b>Print</b> functions to copy the table to your clipboard, export the filter data as an Excel file, plaintext (tab separated values) or print to PDF</li>
			    <li>Use the <b>Clear</b> menu item to clear all selected data and create a new report.</li>
			  </ul>

         </div>
       </div>
     </div>
   </div>
   
  <!-- Main content -->
  <div class="container-fluid mt-2 px-5 py-3">
    <div class="card">
	    <div class="card-header">
		    <h5>Event: <small class="text-muted" id="event_title">None</small></h5>
	    </div>
	    <div class="card-body">
		    <p class="card-text" id="event_details"></p>
	    </div>
    </div>

   <div class="row mt-3">
     <div class="col">
	  <div class="container-fluid mt-3">
              <table id="entry-table" class="table table-striped" width="100%">
                <thead>
	          <tr>
		   <th>Circle</th>
		   <th>Division</th>
		   <th>Class</th>
		   <th>Sail Number</th>
		   <th>Yacht Name</th>
		   <th>Owner</th>
		   <th>Make Model</th>
		   <th>Requested rating</th>
		   <th>MWPHRF Match</th>
		   <th>MWPHRF Rating</th>
		   <th>Valid</th>
	         </tr>
               </thead>
             </table>
	  </div>
     </div>
   </div>

  </div>

<script>
var mwphrf_data = { by_name: {}, by_sail: {}, by_makemodel: {}, all_data: []};

$(document).ready(function() {
	$('#ysevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: 'single',
    		columns: [
			{ data: 'id' },
	    		{ data: 'name' },
			{ data: 'start_date', render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa' }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: false,
	});

	$('#csevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: 'single',
    		columns: [
			{ data: 'id' },
	    		{ data: 'name' },
			{ data: 'start_date', render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa' }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: false,
	});

	$('#rmevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: 'single',
    		columns: [
			{ data: 'id', width:"10%" },
	    		{ data: 'name' },
			{ data: 'start_date', width: "15%", render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa', width: "10%" }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: true,
	});

	$('#entry-table').DataTable({
	     data: [],
	     order: [ [0, 'asc'], [1, 'asc'], [2, 'asc'], [4, 'asc'] ],
    	     columns: [
		{ data: 'racing_circle' },
		{ data: 'racing_division' },
		{ data: 'racing_class' },
		{ data: 'sail_number' },
	        { data: 'name' },
		{ data: 'owners_name' },
		{ data: 'design' },
		{ data: 'ratings.PHRF', defaultContent: '' },
		{ data: 'mwphrf_matches', render: displayMatches },
		{ data: 'mwphrf_selected', render: displayRating },
		{ data: 'is_valid', render: displayValid }
	     ],
	     columnDefs: [
		     { searchPanes: { show:true, collapse: true, initCollapsed: true, }, targets: [0,1,2] },
		     { searchPanes: { initCollapsed: true, show: true, header: "Matches", orderable: false,
			     options: [ 
				     { label: "1", value: function(rowData, rowIdx) { return rowData.mwphrf_matches.size == 1; } },
				     { label: "0", value: function(rowData, rowIdx) { return rowData.mwphrf_matches.size == 0; } },
				     { label: "> 1", value: function(rowData, rowIdx) { return rowData.mwphrf_matches.size > 1; } }
			     ]
		     }, targets: [8] },
		     { searchPanes: { show: true, initCollapsed: true, header: "Valid rating", orderable: false,
			     options: [
				     { label: "Yes", value: function(rowData, rowIdx) { return rowData.is_valid; } },
				     { label: "No", value: function(rowData, rowIdx) { return ! rowData.is_valid; } } ]
		     }, targets: [ 10 ] }, 
		     { searchPanes: { show: false }, targets: [3, 4, 5, 6, 7, 9 ] }
	     ],
    	     rowId: 'id',
    	     pageLength: 50,
    	     language: {
        	emptyTable: "No entries loaded"
      	     },
	     layout: { 
	     	// top2: 'searchPanes',
		topStart:  {
	     		buttons: [ 
	     	{ extend: 'colvis', text: 'Table columns' },
		{ extend: 'searchPanes', text: 'Filters' },
		{ extend: 'copyHtml5', copySuccess: false, footer: false, title: '', 
			exportOptions: { columns: ':visible'} },
		{ extend: 'excel', filename: "MWPHRF Validator - Entries", title: "Entries",
			exportOptions: { columns: ':visible'} },
		{ extend: 'csvHtml5', text: 'TSV', extension: '.txt', filename: "MWPHRF Validator - Entries", 
			fieldBoundary: '', fieldSeparator: '\t', exportOptions: { columns: ':visible'} },
		{ extend: 'print', title: "Entries" } ] } },
	     language: { searchPanes: { collapse: "Filters", loadMessage: "" }}
	});

	$('#cert-table').DataTable({
		data: [],
		order: [ [0, 'asc'] ],
		select: 'single',
    		columns: [
	    		{ data: 'sailNo' },
	    		{ data: 'yachtName' },
	    		{ data: 'makeModel' },
			{ data: 'issueDate', render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'bhcp' },
			{ data: 'hcp' },
			{ data: 'dhcp' },
			{ data: 'nshcp' },
			{ data: 'certificateUrl', render: displayURL }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No certificates available" }, 
		searching: false,
	});
});

function loadEntries(entries) {
	entries.forEach( parseEntry );
	$('#entry-table').DataTable().searchPanes.rebuildPane();
	$('#entry-table').DataTable().draw();
}

function loadEvent(ev) { 
	$('#entry-table').DataTable().clear().draw();
	$('#event_title').html(ev.name);
	const date_diff = ( ev.end_date - ev.start_date ) / ( 1000 * 3600 * 24);
	if ( date_diff >= 1 ) {
		$('#event_details').html(ev.start_date.toLocaleDateString() + " - " + ev.end_date.toLocaleDateString() + "<br>" + ev.oa);
	} else {
		$('#event_details').html(ev.start_date.toLocaleDateString() + "<br>" + ev.oa);
	}
	ev.getEntries( loadEntries );
}

function parseEntry(entry) {
	entry.mwphrf_matches = new MapSet();
	entry.mwphrf_selected = null;
	entry.mwphrf_var = null;
	entry.is_valid = false;
	$('#entry-table').DataTable().row.add(entry);
}

function displayMatches(data, type, row, meta) {
	if ( type == "display" ) {
		const button_class = row.mwphrf_selected != undefined ? "btn-outline-primary" : ( data.size > 1 ? "btn-outline-warning" : "btn-outline-danger" );
		return `<button class="btn ${button_class}" onclick='showSelectCert(${meta.row})'>${data.size}</button>`;
	}
	return data.size;
}

function displayRating(data, type, row, meta) {
	if ( type == "display" ) {
		return data != undefined && row.mwphrf_var != undefined ?
			data[ row.mwphrf_var.toLowerCase() ] + " (" + row.mwphrf_var + ")" :
			"";
	} else {
		return data != undefined && row.mwphrf_var != undefined ?
			data[ row.mwphrf_var.toLowerCase() ] :
			null
	}
}

function displayValid(data, type, row, meta) {
	if ( type == "display" ) {
		const badge_class = data ? "bg-success" : "bg-danger";
		return `<span class="badge rounded-pill ${badge_class}">${data}</span>`;
	} else {
		return data;
	}
}

function isValid(entry) { 
	const cert_var = entry.mwphrf_selected != undefined && entry.mwphrf_var != undefined ? 
			entry.mwphrf_selected[ entry.mwphrf_var.toLowerCase() ] : null;
	return entry.ratings.PHRF != undefined && entry.ratings.PHRF === cert_var;
}

// Function to display the Certificate link in the table
function displayURL(data, type, row, meta) {
        if ( type == "display" ) {
                return `<a class="btn btn-info" href="${data}" target="_blank">View</a>`;
        }
        return data;
}

function runYSSearch() {
	query = $('#ys-search').val();
	const ystable = $('#ysevent-table').DataTable()
	ystable.clear();
	YSEvent.search(query, 1, (events) => { 
		ystable.rows.add(events);
		ystable.columns.adjust().draw();
	});
}

function selectYSEvent() {
	const selrows = $('#ysevent-table').DataTable().rows({ selected: true }).data()
	const ev = selrows[0];
	loadEvent(ev);
	$('#ysevents').modal('hide');
	$('#ysevent-table').DataTable().clear().draw();
}

function runCSSearch() {
	query = $('#cs-search').val();
	const cstable = $('#csevent-table').DataTable();
	cstable.clear();
	CSEvent.search(query, (events) => { 
		cstable.rows.add(events); 
		cstable.columns.adjust().draw();
	});
}

function selectCSEvent() { 
	const selrows = $('#csevent-table').DataTable().rows({ selected: true }).data()	
	const ev = selrows[0];
	loadEvent(ev);
	$('#csevents').modal('hide');
	$('#csevent-table').DataTable().clear().draw();
}

function displayRMDialog() { 
	$('#rmevents').modal('show'); 
	setTimeout( () => { RMEvent.loadTable($('#rmevent-table').DataTable()); }, 500 );
}

function selectRMEvent() { 
	const selrows = $('#rmevent-table').DataTable().rows({ selected: true }).data()	
	const ev = selrows[0];
	loadEvent(ev);
	$('#rmevents').modal('hide');
	$('#rmevent-table').DataTable().clear().draw();
}

function clearTables() { 
	$('#entry-table').DataTable().clear().draw();
	$('#clearData').modal('hide');
	$('#event_title').html('None');
	$('#event_details').html('');
}

var curr_entry;
var sel_row;

function showSelectCert(row_idx) { 
	curr_entry = $('#entry-table').DataTable().row(row_idx).data();
	sel_row = row_idx;
	$('#select-cert-entry').html(`${curr_entry.sail_number} - ${curr_entry.name} - ${curr_entry.design}`);
	$('#select-cert').modal('show');
	const cert_table = $('#cert-table').DataTable();
	cert_table.clear();
	var sel_cert = undefined;
	var curr_row = 0;
	curr_entry.mwphrf_matches.values().forEach( (item) => {
		cert_table.row.add(item);
		if ( item === curr_entry.mwphrf_selected ) sel_cert = curr_row;
		curr_row++;
	});
	if ( sel_cert != undefined ) cert_table.row(sel_cert).select();
	cert_table.draw();
}

function setMatch() {
	const selrows = $('#cert-table').DataTable().rows({ selected: true }).data()
	const sel_cert = selrows[0];
	curr_entry.mwphrf_selected = sel_cert;
	curr_entry.is_valid = isValid(curr_entry);
	$('#entry-table').DataTable().row(sel_row).invalidate().draw();
	curr_entry = undefined;
	sel_row = undefined;
	$('#select-cert').modal('hide');
}

var todo = 0;
var complete = 0;

// Function to find MWPHRF matches
function findMWPHRFMatch() {
	$('#mwphrf_find_btn').prop('disabled', true);
	const match_types = [];
	const entries = $('#entry-table').DataTable().rows({search: 'applied'}).data();
	$('input[name="mwphrf-match"]:checked').each( function () { match_types.push($(this).val()); });
	const match_method = $('#mwphrf-match-method').val();
	const current_year = $('#mwphrf-year').val() === "current";
	const entry_len = entries.length;
	todo = entry_len * match_types.length;
	complete = 0;
	entries.each( (entry, idx) => { makeMWPHRFMatch(entry, match_types, match_method, current_year); } );
}

function makeMWPHRFMatch(entry, match_types, match_method, current_year=false) {
	if ( match_method == "skip" && entry.mwphrf_matches.size > 0 ) 
		return;
	if ( match_method == "overwrite" ) 
		entry.mwphrf_matches.clear();

	match_types.forEach( (a_type) => { 
		switch (a_type) { 
		case "sail": searchMWPHRF('', entry.sail_number.replace(/\D/g, ''), 
			(matches) => { addMWPHRFMatch(entry, matches, current_year) }, true);
			break;
		case "name": searchMWPHRF(a_type, entry.name,
			(matches) => { addMWPHRFMatch(entry, matches, current_year) });
			break;
		case "type": searchMWPHRF(a_type, entry.design,
			(matches) => { addMWPHRFMatch(entry, matches, current_year) });
			break;
		} 
	})
}

function addMWPHRFMatch(entry, matches, current_year=false) { 

	if ( matches.length > 0 ) { 
		if ( current_year ) {
			const this_year = new Date().getFullYear().toString();
			matches.forEach( (item) => { if ( item.validFor.toString() === this_year ) entry.mwphrf_matches.add(item); });
		} else {
			entry.mwphrf_matches.add(...matches);
		}
		// If there is only one match, then set it as the selected one.
		if ( entry.mwphrf_matches.size == 1 ) {
			entry.mwphrf_selected = entry.mwphrf_matches.values().next().value;
			entry.is_valid = isValid(entry);
		} else {
			entry.mwphrf_selected = null;
			entry.is_valid = false;
		}
	}

	complete++;

	if ( complete == todo ) { 
		// All the enties are complete
		$('#entry-table').DataTable().rows({search: 'applied'}).invalidate().draw();
		$('#entry-table').DataTable().searchPanes.rebuildPane();
		$('#mwphrf_find_btn').prop('disabled', false);
		$('#mwphrf-match').modal('hide');
		$('#mwphrf_progress').width(0);
		$('#mwphrf_progress').html("");
	} else {
		const percent = Math.round((complete / todo) * 100) + "%"
		$('#mwphrf_progress').width(percent);
		$('#mwphrf_progress').html(percent);
	}
}

// function to set MWPHRF variables
function setMWPHRFVar() {
	let sel_var = $('#mwphrf-var').val();
	const entry_table = $('#entry-table').DataTable();
	entry_table.rows({search: 'applied'}).data().each( (entry, idx) => { entry.mwphrf_var = sel_var; entry.is_valid = isValid(entry); } );
	entry_table.rows({search: 'applied'}).invalidate().draw();
	entry_table.searchPanes.rebuildPane(5, true);
	$('#mwphrf-setvar').modal('hide');
}
</script>

</body>
</html>




