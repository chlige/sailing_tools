<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>Regatta Exporter</title>
<!-- jQuery -->
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5 -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous" />
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
	crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/be95d6b295.js" crossorigin="anonymous"></script>

<!-- DataTables -->
<!-- Included libraries:
 * To rebuild or modify this file with the latest versions of the included
 * software please visit:
 *   https://datatables.net/download/#bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1
 *
 * Included libraries:
 *  JSZip 3.10.1, DataTables 2.3.2, Buttons 3.2.4, Column visibility 3.2.4, HTML5 export 3.2.4, Print view 3.2.4, ColReorder 2.1.1, DateTime 1.5.6, FixedColumns 5.0.4, FixedHeader 4.0.3, KeyTable 2.12.1, Responsive 3.0.5, RowGroup 1.5.2, Scroller 2.4.3, SearchBuilder 1.8.3, SearchPanes 2.3.4, Select 3.0.1
-->
<link href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1/datatables.min.css" rel="stylesheet" integrity="sha384-AJLr9lKaaCuSjzByAYUCZ33XS5Nl5K+kqmz154VoRrooT7qAG8f71ZhRpdXC+Cw/" crossorigin="anonymous">

<script src="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-colvis-3.2.4/b-html5-3.2.4/b-print-3.2.4/cr-2.1.1/date-1.5.6/fc-5.0.4/fh-4.0.3/kt-2.12.1/r-3.0.5/rg-1.5.2/sc-2.4.3/sb-1.8.3/sp-2.3.4/sl-3.0.1/datatables.min.js" integrity="sha384-01l+g4SkAg57RpPg0lgbZedebEdRAl+YD5+n67Mv/77+6vwyYSMEcrd1glx6eMPa" crossorigin="anonymous"></script>

<script src="js/moment.min.js"></script>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" 
	integrity="sha512-hUhvpC5f8cgc04OZb55j0KNGh4eh7dLxd/dPSJ5VyzqDWxsayYbojWyl5Tkcgrmb/RVKCRJI1jNlRbVP4WWC4w==" 
	crossorigin="anonymous" 
	referrerpolicy="no-referrer"></script>
-->

<script type="text/javascript" src="js/rms.js"></script>
</head>

<body class="d-flex flex-column h-100">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-cloud-arrow-down fa-lg"></i> Regatta Exporter</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
	  <li class="nav-item dropdown">
	    <a class="nav-link dropdown-toggle" href="#" id="navbarLoad" role="button" data-bs-toggle="dropdown" aria-expanded="false">Load</a>
            <ul class="dropdown-menu" aria-labelledby="navbarLoad">
	      <li><a class="dropdown-item" href="#" onclick="$('#ysevents').modal('show')">YachtScoring</a></li>
	      <li><a class="dropdown-item" href="#" onclick="$('#csevents').modal('show')">The ClubSpot</a></li>
	      <li><a class="dropdown-item" href="#" onclick="displayRMDialog()">RailMeets</a></li>
            </ul>
	  </li>
	  <li class="nav-item">
		  <a class="nav-link" href="#" onclick="$('#clearData').modal('show')">Clear data</a>
	  </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="$('#help').modal('show')">Help</a>
          </li>                                                                                                                                                                                                          </ul>
        <span class="d-flex">
          <a class="btn btn-outline-light" href="index.html">All tools</a>
        </span>
      </div>
    </div>
  </nav>

    <!-- Modal to clear data-->
    <div class="modal fade" id="clearData" tabindex="-1" role="dialog" aria-labelledby="Clear data">
      <div class="modal-dialog modal-md modal-fullscreen-md-down" role="document">
        <div class="modal-content">
          <div class="modal-body">
		  <h4>Clear existing table data?</h4>
          </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-danger' onclick="clearTables()">Confirm</button>
         </div>
       </div>
     </div>
   </div>


       <!-- Modal to display help -->
    <div class="modal fade" id="help" tabindex="-1" role="dialog" aria-labelledby="Help">
      <div class="modal-dialog modal-xl modal-fullscreen-lg-down" role="document">
        <div class="modal-content">
          <div class="modal-header">
                  <h5 class="modal-title">Regatta Exporter v1.1</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
		  <p>Export data for regattas from YachtScoring, The ClubSpot and RailMeets.</p>
		<ul>
			<li>Use the <b>Load</b> menu to select events from the different regatta websites.<br>You can select more than one event from more than one platform to create a full report of various regattas.</li>
			<li>You can then inspect the report of <i>Events</i>, <i>Entries</i> and <i>Results</i> for the selected events.<br>Data in each of the tables can be copied to the clipboard, saved as a Microsoft Excel file, plain text (TSV file) or can be printed</li>
			<li>Use the <b>Clear data</b> menu item to clear all selected data and create a new report.</li>
		</ul>
	  </div>
	</div>
      </div>
    </div>
   
    <!-- Modal to select an event from YachtScoring -->
    <div class="modal fade" id="ysevents" tabindex="-1" role="dialog" aria-labelledby="Select YachtScoring Event(s)">
      <div class="modal-dialog modal-xl modal-fullscreen-lg-down" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select YachtScoring Event(s)</h3></div>
          <div class="modal-body">
	    <div class="input-group">
	      <input type="text" id="ys-search" class="form-control" placeholder="Query"/>
	      <button class="btn btn-primary" onclick="runYSSearch()">Search</button>
	    </div>
	    <div class="row mt-2">
              <table id="ysevent-table" class="table table-striped" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectYSEvents()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to select an event from Clubspot -->
    <div class="modal fade" id="csevents" tabindex="-1" role="dialog" aria-labelledby="Select The ClubSpot Event(s)">
      <div class="modal-dialog modal-xl modal-fullscreen-lg-down" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select The ClubSpot Event(s)</h3></div>
          <div class="modal-body">
	    <div class="input-group">
	      <input type="text" id="cs-search" class="form-control" placeholder="Query"/>
	      <button class="btn btn-primary" onclick="runCSSearch()">Search</button>
	    </div>
	    <div class="row mt-2">
              <table id="csevent-table" class="table table-striped" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectCSEvents()">Select</button>
         </div>
       </div>
     </div>
   </div>

    <!-- Modal to select an event from YachtScoring -->
    <div class="modal fade" id="rmevents" tabindex="-1" role="dialog" aria-labelledby="Select RailMeets Event(s)">
      <div class="modal-dialog modal-xl modal-fullscreen-lg-down" role="document">
        <div class="modal-content">
          <div class="modal-header"><h3>Select RailMeets Event(s)</h3></div>
          <div class="modal-body">
	    <div class="row mt-2">
              <table id="rmevent-table" class="table table-striped" style="width:100%">
                <thead>
	          <tr>
		   <th>Event ID</th>
		   <th>Name</th>
		   <th>Dates</th>
		   <th>OA</th>
	         </tr>
               </thead>
             </table>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type='button' class='btn btn-primary' onclick="selectRMEvents()">Select</button>
         </div>
       </div>
     </div>
   </div>
  <!-- Main content -->
  <div class="container-fluid mt-2 px-5 py-3">

   <div class="row mt-3">
     <div class="col">
      <ul class="nav nav-tabs" id="table_tabs" role="tablist">
	      <li class="nav-item" role="presentation">
		     <button class="nav-link active" id="events-tab" 
			     data-bs-toggle="tab" data-bs-target="#events-tab-pane" type="button" role="tab"
			     aria-controls="events-tab-pane" aria-selected="true">Events</button>
	      </li>
	      <li class="nav-item" role="presentation">
		     <button class="nav-link" id="entries-tab" 
			     data-bs-toggle="tab" data-bs-target="#entries-tab-pane" type="button" role="tab"
			     aria-controls="entries-tab-pane" aria-selected="false">Entries</button>
	      </li>
	      <li class="nav-item" role="presentation">
		     <button class="nav-link" id="results-tab" 
			     data-bs-toggle="tab" data-bs-target="#results-tab-pane" type="button" role="tab"
			     aria-controls="results-tab-pane" aria-selected="false">Results</button>
	      </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="events-tab-pane" role="tabpanel" aria-labelledby="events-tab" tabindex="0">
	      <div class="container-fluid mt-3">
                <table id="event-table" class="table table-striped" width="100%">
                  <thead>
	            <tr>
	             <th>Event ID</th>
		     <th>Event Name</th>
		     <th>Start Date</th>
		     <th>End Date</th>
		     <th>OA</th>
	           </tr>
                 </thead>
               </table>
	      </div>
	</div>
	<div class="tab-pane fade" id="entries-tab-pane" role="tabpanel" aria-labelledby="entries-tab" tabindex="0">
	  <div class="container-fluid mt-3">
              <table id="entry-table" class="table table-striped" width="100%">
                <thead>
	          <tr>
	           <th>Event ID</th>
		   <th>Event Name</th>
		   <th>Entry ID</th>
		   <th>Sail Number</th>
		   <th>Yacht Name</th>
		   <th>Make Model</th>
		   <th>Owner</th>
		   <th>Circle</th>
		   <th>Division</th>
		   <th>Class</th>
	         </tr>
               </thead>
             </table>
	      </div>
	      </div>
	      <div class="tab-pane fade" id="results-tab-pane" role="tabpanel" aria-labelledby="results-tab" tabindex="0">
	      <div class="flex-container mt-3">
                <table id="results-table" class="table table-striped" width="100%">
                  <thead>
	            <tr>
	             <th>Event ID</th>
		     <th>Event Name</th>
		     <th>Circle</th>
		     <th>Division</th>
		     <th>Class</th>
		     <th>Entry ID</th>
		     <th>Sail Number</th>
		     <th>Yacht Name</th>
		     <th>Race Number</th>
		     <th>Distance (NMi)</th>
		     <th>Elapsed Time</th>
		     <th>Corrected Time</th>
		     <th>Points</th>
		     <th>Status</th>
	           </tr>
                 </thead>
               </table>
	      </div>
	      </div>
      </div>
     </div>
   </div>

  </div>

<script>

$(document).ready(function() {
	$('#ysevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: { style: 'multi' },
    		columns: [
			{ data: 'id' },
	    		{ data: 'name' },
			{ data: 'start_date', render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa' }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: false,
	});

	$('#csevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: { style: 'multi' },
    		columns: [
			{ data: 'id' },
	    		{ data: 'name' },
			{ data: 'start_date', render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa' }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: false,
	});

	$('#rmevent-table').DataTable({
		data: [],
		order: [ [2, 'desc'] ],
		select: { style: 'multi' },
    		columns: [
			{ data: 'id', width:"10%" },
	    		{ data: 'name' },
			{ data: 'start_date', width: "15%",
				render: DataTable.render.datetime('MMM D, YYYY') },
			{ data: 'oa', width: "10%" }
		],
    		rowId: 'id',
    		pageLength: 10,
		lengthChange: false,
    		language: { emptyTable: "No events available" }, 
		searching: true,
	});

	$('#event-table').DataTable({
	     data: [],
	     order: [ [0, 'asc'] ],
    	     columns: [
		{ data: 'id' },
		{ data: 'name' },
		{ data: 'start_date', render: DataTable.render.datetime('MMM D, YYYY') },
		{ data: 'end_date', render: DataTable.render.datetime('MMM D, YYYY') },
		{ data: 'oa' }
	     ],
    	     rowId: 'id',
    	     pageLength: 50,
    	     language: {
        	emptyTable: "No events loaded"
      	     },
             dom: "Bfrtip",
	     buttons: [ 
	{ extend: 'copyHtml5', copySuccess: false, footer: false, title: '' },
	{ extend: 'excel', filename: "Regatta Exporter - Events", title: "Events" },
	{ extend: 'csvHtml5', text: 'TSV', extension: '.txt', filename: "Regatta Exporter - Events", fieldBoundary: '', fieldSeparator: '\t' },
	{ extend: 'print', title: "Events" }
	     ]} );

	$('#entry-table').DataTable({
	     data: [],
	     order: [ [0, 'asc'] ],
    	     columns: [
		{ data: 'event.id' },
		{ data: 'event.name' },
		{ data: 'id' },
		{ data: 'sail_number' },
	        { data: 'name' },
		{ data: 'design' },
		{ data: 'owners_name' },
		{ data: 'racing_circle' },
		{ data: 'racing_division' },
		{ data: 'racing_class' },
	     ],
    	     rowId: 'id',
    	     pageLength: 50,
    	     language: {
        	emptyTable: "No entries loaded"
      	     },
             dom: "Bfrtip",
	     buttons: [ 
	    	{ extend: 'colvis', text: 'Table columns' },
		    { extend: 'copyHtml5', copySuccess: false, footer: false, title: '', 
		 			exportOptions: { columns: ':visible'} },
		 	{ extend: 'excel', filename: "Regatta Exporter - Entries", title: "Entries",
		 			exportOptions: { columns: ':visible'} },
		 	{ extend: 'csvHtml5', text: 'TSV', extension: '.txt', filename: "Regatta Exporter - Entries", 
		 			fieldBoundary: '', fieldSeparator: '\t', exportOptions: { columns: ':visible'} },
			{ extend: 'print', title: "Entries", exportOptions: { columns: ':visible'} }
	] });

	$('#results-table').DataTable({
	     data: [],
	     order: [ [0, 'asc'] ],
    	     columns: [
		{ data: 'entry.event.id' },
		{ data: 'entry.event.name' },
		{ data: 'entry.racing_circle' },
		{ data: 'entry.racing_division' },
		{ data: 'entry.racing_class' },
		{ data: 'entry.id' },
		{ data: 'entry.sail_number' },
	        { data: 'entry.name' },
		{ data: 'race.race_number' },
		{ data: 'race.distance' },
		{ data: 'elapsed_time', render: displayDuration },
		{ data: 'corrected_time', render: displayDuration },
		{ data: 'points', },
		{ data: 'status' }
	     ],
    	     rowId: 'id',
    	     pageLength: 50,
    	     language: {
        	emptyTable: "No results loaded"
      	     },
             dom: "Bfrtip",
	     buttons: [ 
	    	{ extend: 'colvis', text: 'Table columns' },
	    	{ extend: 'copyHtml5', copySuccess: false, footer: false, title: '', 
	 			exportOptions: { columns: ':visible'} },
	 		{ extend: 'excel', filename: "Regatta Exporter - Results", title: "Results",
	 			exportOptions: { columns: ':visible'} },
	 		{ extend: 'csvHtml5', text: 'TSV', extension: '.txt', filename: "Regatta Exporter - Results", 
	 			fieldBoundary: '', fieldSeparator: '\t', exportOptions: { columns: ':visible'} },
			{ extend: 'print', title: "Results", exportOptions: { columns: ':visible'} }
	] });
});

function displayDuration(data, type, row, meta) {
	if ( type == "display" ) { 
		if (data.asSeconds() == 0) {
			return "-";
		}
		let duration_string = data.minutes().toString().padStart(2, "0") + ":" + data.seconds().toString().padStart(2, "0");
		if ( data.hours() >= 1 )
			duration_string = data.hours().toString().padStart(2, "0") + ":" + duration_string;
		if ( data.days() >= 1 )
			duration_string = data.days() + ":" + duration_string;
		return duration_string;
	} else {
		return data.asSeconds();
	}
}

function runYSSearch() {
	query = $('#ys-search').val();
	const ystable = $('#ysevent-table').DataTable()
        ystable.clear();
        YSEvent.search(query, 1, (events) => {
                ystable.rows.add(events);
                ystable.columns.adjust().draw();
        });
}

function selectYSEvents() { 
	let selrows = $('#ysevent-table').DataTable().rows({ selected: true }).data()	
	selrows.map( (ev) => { 
		$('#event-table').DataTable().row.add( ev ).draw();
		ev.getEntries( (data) => { $('#entry-table').DataTable().rows.add(data).draw() });
		ev.getResults( (data) => { $('#results-table').DataTable().rows.add(data).draw() });
	});
	$('#ysevents').modal('hide');
	$('#ysevent-table').DataTable().clear().draw();
}

function runCSSearch() {
	query = $('#cs-search').val();
	const cstable = $('#csevent-table').DataTable();
	cstable.clear();
	CSEvent.search(query, (events) => { 
		cstable.rows.add(events);
		cstable.columns.adjust().draw(); 
	});
}

function selectCSEvents() { 
	let selrows = $('#csevent-table').DataTable().rows({ selected: true }).data()	
	selrows.map( (ev) => { 
		$('#event-table').DataTable().row.add( ev ).draw();
		ev.getEntries( (data) => { $('#entry-table').DataTable().rows.add(data).draw() });
		ev.getResults( (data) => { $('#results-table').DataTable().rows.add(data).draw() });
	});
	$('#csevents').modal('hide');
	$('#csevent-table').DataTable().clear().draw();
}

function clearTables() { 
	$('#event-table').DataTable().clear().draw();
	$('#entry-table').DataTable().clear().draw();
	$('#results-table').DataTable().clear().draw();
	$('#clearData').modal('hide');
}

function displayRMDialog() { 
	$('#rmevents').modal('show'); 
	setTimeout( () => { RMEvent.loadTable($('#rmevent-table').DataTable()); }, 500 );
}

function selectRMEvents() { 
	let selrows = $('#rmevent-table').DataTable().rows({ selected: true }).data()	
	selrows.map( (ev) => { 
		$('#event-table').DataTable().row.add( ev ).draw();
		ev.getEntries( (data) => { $('#entry-table').DataTable().rows.add(data).draw() });
		ev.getResults( (data) => { $('#results-table').DataTable().rows.add(data).draw() });
	});
	$('#rmevents').modal('hide');
	$('#rmevent-table').DataTable().clear().draw();
}

</script>

</body>
</html>
